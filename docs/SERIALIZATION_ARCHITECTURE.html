<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Serialization Architecture for Reindeer Cache • reindeer</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Serialization Architecture for Reindeer Cache"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">reindeer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.17</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="index.html"><span class="fa fas fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/Tidy_speech_processing.html">Tidy Speech Processing</a></li>
    <li><a class="dropdown-item" href="articles/metadata_management.html">Metadata Management</a></li>
    <li><a class="dropdown-item" href="articles/transcription_workflow.html">Transcription Workflow</a></li>
    <li><a class="dropdown-item" href="articles/simulation-infrastructure.html">Simulation Infrastructure</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/humlab-speech/reindeer"><span class="fa fab fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Serialization Architecture for Reindeer Cache</h1>

    </div>

<div id="serialization-architecture-for-reindeer-cache" class="section level1">

<div class="section level2">
<h2 id="current-architecture">Current Architecture<a class="anchor" aria-label="anchor" href="#current-architecture"></a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                      quantify() Method                       │
│                                                              │
│  Input: segment_list + dsp_function                         │
│  Output: extended_segment_list with DSP measurements        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │  .use_cache = TRUE?    │
        └────────┬───────────────┘
                 │
        ┌────────┴────────┐
        │ YES             │ NO
        ▼                 ▼
┌───────────────┐   ┌──────────────┐
│ Check cache   │   │ Process DSP  │
│ for each      │   │ directly     │
│ segment       │   └──────────────┘
└───────┬───────┘
        │
        ▼
┌──────────────────────────────────────────────┐
│  SQLite Cache Database                       │
│  Location: tempdir()/reindeer_cache/         │
│           quantify_cache.sqlite              │
│                                              │
│  Table: cache                                │
│  ┌────────────────────────────────────┐     │
│  │ cache_key       TEXT PK            │     │
│  │ result_blob     BLOB ◄─────────────┼──┐  │
│  │ created_at      INTEGER            │  │  │
│  │ accessed_at     INTEGER            │  │  │
│  │ size_bytes      INTEGER            │  │  │
│  └────────────────────────────────────┘  │  │
└─────────────────────────────────────────┼──┘
                                          │
                                          ▼
                            ┌──────────────────────────┐
                            │ CURRENT: serialize()     │
                            │                          │
                            │ R native serialization   │
                            │ • Slower (1x baseline)   │
                            │ • Larger files (100%)    │
                            │ • Universal support      │
                            └──────────────────────────┘</code></pre>
</div>
<div class="section level2">
<h2 id="cache-key-generation">Cache Key Generation<a class="anchor" aria-label="anchor" href="#cache-key-generation"></a></h2>
<pre><code>cache_key = hash(
    session name,
    bundle name,
    segment start time,
    segment end time,
    DSP function name,
    DSP parameters
)

Example: "sess01_bndl03_100.5_250.3_forest_nominalF1=500"</code></pre>
</div>
<div class="section level2">
<h2 id="current-serialization-flow">Current Serialization Flow<a class="anchor" aria-label="anchor" href="#current-serialization-flow"></a></h2>
<pre><code>DSP Result (tibble)
       │
       ▼
serialize(result, NULL)
       │
       ▼
Raw vector (bytes)
       │
       ▼
Store in SQLite BLOB
       │
       ▼
[Cache Database]


[Cache Database]
       │
       ▼
Read BLOB column
       │
       ▼
Raw vector (bytes)
       │
       ▼
unserialize(blob)
       │
       ▼
DSP Result (tibble)</code></pre>
<hr></div>
<div class="section level2">
<h2 id="proposed-architecture-with-qs">Proposed Architecture with qs<a class="anchor" aria-label="anchor" href="#proposed-architecture-with-qs"></a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────┐
│                      quantify() Method                       │
│                                                              │
│  Input: segment_list + dsp_function                         │
│  Output: extended_segment_list with DSP measurements        │
│  NEW: .cache_format = c("auto", "qs", "rds")               │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │  .use_cache = TRUE?    │
        └────────┬───────────────┘
                 │
        ┌────────┴────────┐
        │ YES             │ NO
        ▼                 ▼
┌───────────────┐   ┌──────────────┐
│ Check cache   │   │ Process DSP  │
│ for each      │   │ directly     │
│ segment       │   └──────────────┘
└───────┬───────┘
        │
        ▼
┌──────────────────────────────────────────────┐
│  UPDATED SQLite Cache Database               │
│  Location: tempdir()/reindeer_cache/         │
│           quantify_cache.sqlite              │
│                                              │
│  Table: cache                                │
│  ┌────────────────────────────────────┐     │
│  │ cache_key       TEXT PK            │     │
│  │ result_blob     BLOB ◄─────────────┼──┐  │
│  │ format          TEXT NEW! ─────────┼──┼─┐│
│  │ created_at      INTEGER            │  │ ││
│  │ accessed_at     INTEGER            │  │ ││
│  │ size_bytes      INTEGER            │  │ ││
│  └────────────────────────────────────┘  │ ││
└─────────────────────────────────────────┼─┼─┘
                                          │ │
                      ┌───────────────────┘ │
                      │                     │
                      ▼                     ▼
        ┌──────────────────────┐  ┌──────────────────────┐
        │ NEW: qs package      │  │ LEGACY: serialize()  │
        │                      │  │                      │
        │ qs::qserialize()     │  │ R native serialize() │
        │ • 3-4x faster        │  │ • Backward compat    │
        │ • 70-80% size        │  │ • Fallback option    │
        │ • Better compression │  │ • If qs unavailable  │
        └──────────────────────┘  └──────────────────────┘</code></pre>
</div>
<div class="section level2">
<h2 id="proposed-serialization-flow">Proposed Serialization Flow<a class="anchor" aria-label="anchor" href="#proposed-serialization-flow"></a></h2>
<pre><code>DSP Result (tibble)
       │
       ├─────────────┬──────────────┐
       │ format="qs" │ format="rds" │
       ▼             ▼              │
qs::qserialize()  serialize()      │
   preset="fast"                    │
       │             │              │
       ▼             ▼              │
Raw vector (bytes)                  │
  70-80% of serialize() size        │
       │             │              │
       └─────────┬───┘              │
                 ▼                  │
  Store in SQLite BLOB              │
    + format marker                 │
       │                            │
       ▼                            │
[Cache Database]                    │
                                    │
                                    │
[Cache Database]                    │
       │                            │
       ▼                            │
Read BLOB + format column           │
       │                            │
       ├─────────────┬──────────────┘
       │ format="qs" │ format="rds"
       ▼             ▼
qs::qdeserialize()  unserialize()
       │             │
       └─────────┬───┘
                 ▼
       DSP Result (tibble)</code></pre>
<hr></div>
<div class="section level2">
<h2 id="migration-strategy">Migration Strategy<a class="anchor" aria-label="anchor" href="#migration-strategy"></a></h2>
<div class="section level3">
<h3 id="phase-1-dual-format-support">Phase 1: Dual Format Support<a class="anchor" aria-label="anchor" href="#phase-1-dual-format-support"></a></h3>
<pre><code>Existing Cache Entries                New Cache Entries
┌──────────────────┐                 ┌──────────────────┐
│ format = NULL    │ ──────┐         │ format = "qs"    │
│ or "rds"         │       │         │                  │
│                  │       │         │ Uses qs if       │
│ Uses serialize() │       │         │ available        │
└──────────────────┘       │         └──────────────────┘
         │                 │                  │
         │                 ▼                  │
         │         ┌──────────────┐          │
         │         │ Read Logic:  │          │
         └────────►│ Check format │◄─────────┘
                   │ Dispatch     │
                   │ accordingly  │
                   └──────────────┘</code></pre>
</div>
<div class="section level3">
<h3 id="phase-2-optional-conversion">Phase 2: Optional Conversion<a class="anchor" aria-label="anchor" href="#phase-2-optional-conversion"></a></h3>
<pre><code>User runs: convert_cache_format()

Old RDS Entries              New qs Entries
┌──────────────────┐        ┌──────────────────┐
│ result_blob (RDS)│        │ result_blob (qs) │
│ format = "rds"   │   ─►   │ format = "qs"    │
│ size = 100 KB    │        │ size = 70 KB     │
└──────────────────┘        └──────────────────┘
                                     │
                                     ▼
                            30% storage savings</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="performance-comparison">Performance Comparison<a class="anchor" aria-label="anchor" href="#performance-comparison"></a></h2>
<div class="section level3">
<h3 id="serialization-speed-write-to-cache">Serialization Speed (write to cache)<a class="anchor" aria-label="anchor" href="#serialization-speed-write-to-cache"></a></h3>
<pre><code>serialize()  ████████████████████████████████████████ 120ms
qs (fast)    ███████████                              35ms  ◄── 3.4x faster
qs (balanced)████████████████                         50ms  ◄── 2.4x faster
fst*         ████                                     12ms  ◄── 10x faster
                                                           (*data frames only)</code></pre>
</div>
<div class="section level3">
<h3 id="deserialization-speed-read-from-cache">Deserialization Speed (read from cache)<a class="anchor" aria-label="anchor" href="#deserialization-speed-read-from-cache"></a></h3>
<pre><code>unserialize()████████████████████████████████████    100ms
qs (fast)    ████████                                 28ms  ◄── 3.6x faster
qs (balanced)████████████                             38ms  ◄── 2.6x faster
fst*         ███                                      10ms  ◄── 10x faster
                                                           (*data frames only)</code></pre>
</div>
<div class="section level3">
<h3 id="storage-size">Storage Size<a class="anchor" aria-label="anchor" href="#storage-size"></a></h3>
<pre><code>serialize()  ████████████████████████████████████████ 940 KB (100%)
qs (fast)    ████████████████████████████             710 KB (76%)  ◄── 24% savings
qs (balanced)████████████████████████                 560 KB (60%)  ◄── 40% savings
fst*         ██████████████████████                   550 KB (58%)  ◄── 42% savings
                                                                   (*data frames only)</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="data-flow-example">Data Flow Example<a class="anchor" aria-label="anchor" href="#data-flow-example"></a></h2>
<div class="section level3">
<h3 id="quantify-1000-segments-with-caching">Quantify 1000 segments with caching<a class="anchor" aria-label="anchor" href="#quantify-1000-segments-with-caching"></a></h3>
<pre><code>quantify(segments, dsp_function, .use_cache = TRUE)

Iteration 1: Fresh analysis
┌──────────────────────────────────────────────────────┐
│ Check cache: 0 hits, 1000 misses                     │
│ Process DSP: 1000 segments (60 seconds)              │
│ Serialize with qs: ~40ms total (0.04ms each)         │
│ Store in cache: 1000 entries                         │
│ Total time: 60 seconds                               │
└──────────────────────────────────────────────────────┘

Iteration 2: Re-analysis with cache
┌──────────────────────────────────────────────────────┐
│ Check cache: 1000 hits, 0 misses                     │
│ Deserialize with qs: ~30ms total (0.03ms each)       │
│ Total time: 0.03 seconds ◄── 2000x faster!           │
└──────────────────────────────────────────────────────┘

Iteration 3: Partial cache (new parameters)
┌──────────────────────────────────────────────────────┐
│ Check cache: 500 hits, 500 misses                    │
│ Deserialize 500: ~15ms                               │
│ Process DSP: 500 segments (30 seconds)               │
│ Serialize 500: ~20ms                                 │
│ Total time: 30 seconds ◄── 50% cache hit = 50% faster│
└──────────────────────────────────────────────────────┘</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="implementation-files">Implementation Files<a class="anchor" aria-label="anchor" href="#implementation-files"></a></h2>
<div class="section level3">
<h3 id="files-to-modify">Files to Modify<a class="anchor" aria-label="anchor" href="#files-to-modify"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>R/tidy_trackdata_helpers.R</strong> (lines 242-337)
<ul><li><code>.get_persistent_cache_connection()</code></li>
<li><code>.get_persistent_cache()</code></li>
<li><code>.set_persistent_cache()</code></li>
</ul></li>
<li>
<strong>R/reindeer_segment_list.R</strong> (line 523)
<ul><li>Add <code>.cache_format</code> parameter to <code><a href="reference/quantify.html">quantify()</a></code>
</li>
</ul></li>
<li>
<strong>Database schema migration</strong>
<ul><li>Add <code>format</code> column to cache table</li>
<li>Create index on format column</li>
</ul></li>
<li>
<strong>DESCRIPTION</strong>
<ul><li>Add <code>qs (&gt;= 0.25.0)</code> to Suggests</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="files-to-create">Files to Create<a class="anchor" aria-label="anchor" href="#files-to-create"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>R/cache_utils.R</strong> (new)
<ul><li><code><a href="reference/convert_cache_format.html">convert_cache_format()</a></code></li>
<li><code><a href="reference/cache_summary.html">cache_summary()</a></code></li>
<li><code><a href="reference/clear_cache.html">clear_cache()</a></code></li>
</ul></li>
<li>
<strong>tests/testthat/test-cache-serialization.R</strong> (new)
<ul><li>Test qs round-trip</li>
<li>Test mixed format cache</li>
<li>Test fallback to serialize</li>
</ul></li>
<li>
<strong>benchmarking/benchmark_serialization.R</strong> (created)
<ul><li>Comprehensive benchmarks</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="documentation-to-update">Documentation to Update<a class="anchor" aria-label="anchor" href="#documentation-to-update"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>man/quantify.Rd</strong>
<ul><li>Document <code>.cache_format</code> parameter</li>
<li>Note performance characteristics</li>
</ul></li>
<li>
<strong>vignettes/performance.Rmd</strong>
<ul><li>Add section on cache optimization</li>
<li>Show benchmark results</li>
</ul></li>
<li>
<strong>NEWS.md</strong>
<ul><li>Announce qs integration</li>
<li>Note performance improvements</li>
</ul></li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="backward-compatibility-strategy">Backward Compatibility Strategy<a class="anchor" aria-label="anchor" href="#backward-compatibility-strategy"></a></h2>
<pre><code>Old code (still works):
  quantify(segments, dsp_function, .use_cache = TRUE)

New code (automatic):
  quantify(segments, dsp_function, .use_cache = TRUE)
  # Uses qs automatically if installed

Force old behavior:
  quantify(segments, dsp_function,
           .use_cache = TRUE,
           .cache_format = "rds")

Force new behavior:
  quantify(segments, dsp_function,
           .use_cache = TRUE,
           .cache_format = "qs")</code></pre>
<hr></div>
<div class="section level2">
<h2 id="error-handling">Error Handling<a class="anchor" aria-label="anchor" href="#error-handling"></a></h2>
<pre><code>Scenario 1: qs requested but not installed
  ┌─────────────────────────────────────┐
  │ Warning: qs not available           │
  │ Falling back to serialize()         │
  └─────────────────────────────────────┘

Scenario 2: Corrupted cache entry
  ┌─────────────────────────────────────┐
  │ Try qs deserialization              │
  │   ├─► Error                         │
  │   └─► Try unserialize()             │
  │         ├─► Error                   │
  │         └─► Remove cache entry      │
  │             Recompute               │
  └─────────────────────────────────────┘

Scenario 3: Unknown format marker
  ┌─────────────────────────────────────┐
  │ format = "unknown"                  │
  │ Default to unserialize()            │
  │ (backward compatibility)            │
  └─────────────────────────────────────┘</code></pre>
<hr></div>
<div class="section level2">
<h2 id="resource-management">Resource Management<a class="anchor" aria-label="anchor" href="#resource-management"></a></h2>
<div class="section level3">
<h3 id="cache-size-management">Cache Size Management<a class="anchor" aria-label="anchor" href="#cache-size-management"></a></h3>
<pre><code>Current logic:
  If cache &gt; max_cache_size_mb (default 1000 MB):
    Remove oldest 25% of entries by accessed_at

With qs (35% smaller):
  Same 1000 MB limit → store ~54% more entries
  OR: Reduce limit to 650 MB → same capacity</code></pre>
</div>
<div class="section level3">
<h3 id="memory-considerations">Memory Considerations<a class="anchor" aria-label="anchor" href="#memory-considerations"></a></h3>
<pre><code>serialize():     ~2x object size in memory during serialization
qs:              ~1.5x object size in memory during serialization
                 (slightly more efficient memory usage)</code></pre>
<hr></div>
</div>
<div class="section level2">
<h2 id="testing-matrix">Testing Matrix<a class="anchor" aria-label="anchor" href="#testing-matrix"></a></h2>
<table class="table"><thead><tr><th>Test Case</th>
<th>serialize()</th>
<th>qs</th>
<th>fst</th>
</tr></thead><tbody><tr><td>tibble</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr><tr><td>data.frame</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr><tr><td>S7 object</td>
<td>✓</td>
<td>✓</td>
<td>✗</td>
</tr><tr><td>list</td>
<td>✓</td>
<td>✓</td>
<td>✗</td>
</tr><tr><td>nested data</td>
<td>✓</td>
<td>✓</td>
<td>✗</td>
</tr><tr><td>NA values</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr><tr><td>Special values (Inf, NaN)</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr><tr><td>Large objects (&gt;100 MB)</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr><tr><td>Round-trip fidelity</td>
<td>✓</td>
<td>✓</td>
<td>✓*</td>
</tr></tbody></table><p>*fst has some type limitations</p>
<hr></div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a></h2>
<p>The proposed qs integration provides: - <strong>Minimal code changes</strong> (3-4 functions) - <strong>Backward compatibility</strong> (automatic fallback) - <strong>Significant performance gains</strong> (3-4x faster) - <strong>Storage efficiency</strong> (24-40% smaller) - <strong>Low risk</strong> (well-tested package)</p>
<p>Ready for implementation.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/frkkan96" class="external-link">Fredrik Karlsson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

