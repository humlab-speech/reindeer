<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Performance Analysis: tidy_trackdata.R • reindeer</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Performance Analysis: tidy_trackdata.R"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">reindeer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.17</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="index.html"><span class="fa fas fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/Tidy_speech_processing.html">Tidy Speech Processing</a></li>
    <li><a class="dropdown-item" href="articles/metadata_management.html">Metadata Management</a></li>
    <li><a class="dropdown-item" href="articles/transcription_workflow.html">Transcription Workflow</a></li>
    <li><a class="dropdown-item" href="articles/simulation-infrastructure.html">Simulation Infrastructure</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">News</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/humlab-speech/reindeer"><span class="fa fab fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Performance Analysis: tidy_trackdata.R</h1>

    </div>

<div id="performance-analysis-tidy_trackdatar" class="section level1">

<div class="section level2">
<h2 id="executive-summary">Executive Summary<a class="anchor" aria-label="anchor" href="#executive-summary"></a></h2>
<p>Analysis of <code>tidy_trackdata.R</code> reveals several significant performance optimization opportunities, particularly in database operations, metadata handling, and parallel processing.</p>
</div>
<div class="section level2">
<h2 id="critical-performance-issues">Critical Performance Issues<a class="anchor" aria-label="anchor" href="#critical-performance-issues"></a></h2>
<div class="section level3">
<h3 id="id_1-repeated-database-loading-high-impact">1. Repeated Database Loading (HIGH IMPACT)<a class="anchor" aria-label="anchor" href="#id_1-repeated-database-loading-high-impact"></a></h3>
<p><strong>Location</strong>: Lines 1030-1046 in <code>quantify.segmentlist()</code></p>
<p><strong>Problem</strong>: The database handle is loaded from <code>basePath</code> attribute multiple times per function call:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/capture.output.html" class="external-link">capture.output</a></span><span class="op">(</span></span>
<span>  <span class="va">.inside_of</span> <span class="op">&lt;-</span> <span class="fu">emuR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/emuR/man/load_emuDB.html" class="external-link">load_emuDB</a></span><span class="op">(</span><span class="va">.inside_of</span>,verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">dbload.info</span></span></code></pre></div>
<p><strong>Impact</strong>: Unnecessary I/O and connection overhead for every quantify() call</p>
<p><strong>Solution</strong>: - Cache database handle in corpus object - Reuse existing connection instead of reloading - Add <code>@connection</code> property to corpus S7 class</p>
<p><strong>Estimated Speedup</strong>: 10-20% for functions with many database operations</p>
<hr></div>
<div class="section level3">
<h3 id="id_2-metadata-retrieval-not-cached-high-impact">2. Metadata Retrieval Not Cached (HIGH IMPACT)<a class="anchor" aria-label="anchor" href="#id_2-metadata-retrieval-not-cached-high-impact"></a></h3>
<p><strong>Location</strong>: Line 1268</p>
<p><strong>Problem</strong>: <code><a href="reference/get_metadata.html">get_metadata()</a></code> queries database every time quantify() is called:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu">reindeer</span><span class="fu">:::</span><span class="fu"><a href="reference/get_metadata.html">get_metadata</a></span><span class="op">(</span><span class="va">.inside_of</span>,manditory<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">.metadata_defaults</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Redundant database queries when processing multiple segment lists</p>
<p><strong>Solution</strong>: - Add metadata cache to corpus object - Use <code>memoise</code> package to cache get_metadata() results - Invalidate cache only when <code>.meta_json</code> files change - Store in <code>@metadata_cache</code> property</p>
<p><strong>Estimated Speedup</strong>: 15-30% for metadata-dependent operations</p>
<hr></div>
<div class="section level3">
<h3 id="id_3-signal-files-list-reconstructed-repeatedly-medium-impact">3. Signal Files List Reconstructed Repeatedly (MEDIUM IMPACT)<a class="anchor" aria-label="anchor" href="#id_3-signal-files-list-reconstructed-repeatedly-medium-impact"></a></h3>
<p><strong>Location</strong>: Line 1238</p>
<p><strong>Problem</strong>: <code><a href="https://rdrr.io/pkg/reindeer/man/list_files.html" class="external-link">list_files()</a></code> called every time instead of using optimized <code><a href="https://rdrr.io/pkg/reindeer/man/peek_signals.html" class="external-link">peek_signals()</a></code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">signalFiles</span> <span class="op">&lt;-</span> <span class="fu">emuR</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/emuR/man/list_files.html" class="external-link">list_files</a></span><span class="op">(</span><span class="va">.inside_of</span>,<span class="va">inputSignalsExtension</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Slow emuR function called when faster alternative exists</p>
<p><strong>Solution</strong>: - Replace with <code><a href="https://rdrr.io/pkg/reindeer/man/peek_signals.html" class="external-link">peek_signals()</a></code> which uses direct filesystem scan - Cache result in corpus object as <code>@signal_files_cache</code> - Update cache only when files added/removed</p>
<p><strong>Estimated Speedup</strong>: 20-40% for this operation</p>
<hr></div>
<div class="section level3">
<h3 id="id_4-row-wise-processing-high-impact">4. Row-wise Processing (HIGH IMPACT)<a class="anchor" aria-label="anchor" href="#id_4-row-wise-processing-high-impact"></a></h3>
<p><strong>Location</strong>: Line 1401-1403</p>
<p><strong>Problem</strong>: Using <code>rowwise()</code> which is notoriously slow:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">appliedDFResultInList</span> <span class="op">&lt;-</span> <span class="va">segmentDSPDF</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span>.f<span class="op">=</span><span class="va">processAndStore</span>,.progress <span class="op">=</span> <span class="va">pb</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Sequential processing when operations are independent</p>
<p><strong>Solution</strong>: - Remove <code>rowwise()</code> - it’s unnecessary here - Use <code><a href="https://furrr.futureverse.org/reference/future_map2.html" class="external-link">furrr::future_pmap()</a></code> for parallel processing - Add <code>.parallel</code> parameter (default TRUE)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">.parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">appliedDFResultInList</span> <span class="op">&lt;-</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/future_map2.html" class="external-link">future_pmap</a></span><span class="op">(</span></span>
<span>    <span class="va">segmentDSPDF</span>,</span>
<span>    <span class="va">processAndStore</span>,</span>
<span>    .options <span class="op">=</span> <span class="fu">furrr</span><span class="fu">::</span><span class="fu"><a href="https://furrr.futureverse.org/reference/furrr_options.html" class="external-link">furrr_options</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .progress <span class="op">=</span> <span class="va">pb</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">appliedDFResultInList</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span><span class="va">segmentDSPDF</span>, <span class="va">processAndStore</span>, .progress <span class="op">=</span> <span class="va">pb</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Estimated Speedup</strong>: 2-4x on multi-core systems</p>
<hr></div>
<div class="section level3">
<h3 id="id_5-multiple-sequential-joins-medium-impact">5. Multiple Sequential Joins (MEDIUM IMPACT)<a class="anchor" aria-label="anchor" href="#id_5-multiple-sequential-joins-medium-impact"></a></h3>
<p><strong>Location</strong>: Lines 1269-1299</p>
<p><strong>Problem</strong>: Multiple <code>left_join()</code> operations performed sequentially:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meta</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">dsp</span>,by <span class="op">=</span> <span class="va">.dsp_settings_by</span><span class="op">)</span></span>
<span><span class="va">completedStoredDSPSettings</span> <span class="op">&lt;-</span> <span class="va">meta</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">dsp</span>,by <span class="op">=</span> <span class="va">.dsp_settings_by</span><span class="op">)</span></span>
<span><span class="va">sessionBundleDSPSettingsDF</span> <span class="op">&lt;-</span> <span class="va">completedStoredDSPSettings</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">signalFiles</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"session"</span>,<span class="st">"bundle"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Multiple passes through data</p>
<p><strong>Solution</strong>: - Use <code>data.table</code> for faster joins - Combine joins where possible - Pre-index on join keys</p>
<p><strong>Estimated Speedup</strong>: 10-20% for large datasets</p>
<hr></div>
<div class="section level3">
<h3 id="id_6-quantify2-double-nesting-medium-impact">6. quantify2() Double Nesting (MEDIUM IMPACT)<a class="anchor" aria-label="anchor" href="#id_6-quantify2-double-nesting-medium-impact"></a></h3>
<p><strong>Location</strong>: Lines 2013-2044</p>
<p><strong>Problem</strong>: Nested data structures created twice independently:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="va">df1_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">group_by_vars</span><span class="op">)</span>, .key <span class="op">=</span> <span class="va">param1_name</span><span class="op">)</span></span>
<span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">df2_base</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">group_by_vars</span><span class="op">)</span>, .key <span class="op">=</span> <span class="va">param2_name</span><span class="op">)</span></span></code></pre></div>
<p><strong>Impact</strong>: Redundant nesting operations</p>
<p><strong>Solution</strong>: - Add file paths before nesting (already done) - Consider single combined data structure if patterns allow</p>
<p><strong>Estimated Speedup</strong>: 5-10%</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="optimization-recommendations-prioritized">Optimization Recommendations (Prioritized)<a class="anchor" aria-label="anchor" href="#optimization-recommendations-prioritized"></a></h2>
<div class="section level3">
<h3 id="tier-1-immediate-high-impact-changes">Tier 1: Immediate High-Impact Changes<a class="anchor" aria-label="anchor" href="#tier-1-immediate-high-impact-changes"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Remove <code>rowwise()</code> and add parallel processing</strong>
<ul><li>Implementation time: 30 minutes</li>
<li>Expected speedup: 2-4x on multi-core systems</li>
<li>No breaking changes</li>
</ul></li>
<li>
<strong>Cache metadata in corpus object</strong>
<ul><li>Implementation time: 2 hours</li>
<li>Expected speedup: 15-30%</li>
<li>Requires corpus S7 class modification</li>
</ul></li>
<li>
<strong>Replace <code><a href="https://rdrr.io/pkg/reindeer/man/list_files.html" class="external-link">list_files()</a></code> with cached <code><a href="https://rdrr.io/pkg/reindeer/man/peek_signals.html" class="external-link">peek_signals()</a></code></strong>
<ul><li>Implementation time: 1 hour</li>
<li>Expected speedup: 20-40% for this operation</li>
<li>No breaking changes</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="tier-2-medium-impact-changes">Tier 2: Medium-Impact Changes<a class="anchor" aria-label="anchor" href="#tier-2-medium-impact-changes"></a></h3>
<ol start="4" style="list-style-type: decimal"><li>
<strong>Cache database handle in corpus</strong>
<ul><li>Implementation time: 1 hour</li>
<li>Expected speedup: 10-20%</li>
<li>Requires corpus modification</li>
</ul></li>
<li>
<strong>Optimize joins with data.table</strong>
<ul><li>Implementation time: 3 hours</li>
<li>Expected speedup: 10-20% for large datasets</li>
<li>Adds dependency on data.table</li>
</ul></li>
<li>
<strong>Memoize expensive database queries</strong>
<ul><li>Implementation time: 2 hours</li>
<li>Expected speedup: 15-25%</li>
<li>Adds dependency on memoise</li>
</ul></li>
</ol></div>
<div class="section level3">
<h3 id="tier-3-nice-to-have-optimizations">Tier 3: Nice-to-Have Optimizations<a class="anchor" aria-label="anchor" href="#tier-3-nice-to-have-optimizations"></a></h3>
<ol start="7" style="list-style-type: decimal"><li>
<strong>Vectorize string operations</strong>
<ul><li>File path construction</li>
<li>Extension matching</li>
<li>Implementation time: 2 hours</li>
<li>Expected speedup: 5-10%</li>
</ul></li>
<li>
<strong>Implement connection pooling</strong>
<ul><li>Implementation time: 3 hours</li>
<li>Expected speedup: 5-10%</li>
<li>More complex, lower benefit</li>
</ul></li>
<li>
<strong>Parallel directory scanning in peek_signals()</strong>
<ul><li>Only beneficial for databases with 1000+ bundles</li>
<li>Implementation time: 1 hour</li>
<li>Expected speedup: Minimal for most use cases</li>
</ul></li>
</ol></div>
</div>
<div class="section level2">
<h2 id="implementation-strategy">Implementation Strategy<a class="anchor" aria-label="anchor" href="#implementation-strategy"></a></h2>
<div class="section level3">
<h3 id="phase-1-quick-wins-1-day">Phase 1: Quick Wins (1 day)<a class="anchor" aria-label="anchor" href="#phase-1-quick-wins-1-day"></a></h3>
<ul><li>Remove rowwise()</li>
<li>Add parallel processing option</li>
<li>Replace list_files() with peek_signals()</li>
</ul></div>
<div class="section level3">
<h3 id="phase-2-caching-infrastructure-2-3-days">Phase 2: Caching Infrastructure (2-3 days)<a class="anchor" aria-label="anchor" href="#phase-2-caching-infrastructure-2-3-days"></a></h3>
<ul><li>Add metadata cache to corpus</li>
<li>Add signal files cache to corpus</li>
<li>Cache database handle</li>
<li>Implement cache invalidation logic</li>
</ul></div>
<div class="section level3">
<h3 id="phase-3-advanced-optimizations-3-4-days">Phase 3: Advanced Optimizations (3-4 days)<a class="anchor" aria-label="anchor" href="#phase-3-advanced-optimizations-3-4-days"></a></h3>
<ul><li>Implement memoization for queries</li>
<li>Optimize joins with data.table</li>
<li>Add benchmarking tests</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="estimated-overall-performance-improvement">Estimated Overall Performance Improvement<a class="anchor" aria-label="anchor" href="#estimated-overall-performance-improvement"></a></h2>
<p>With all Tier 1 and Tier 2 optimizations: - <strong>Sequential processing</strong>: 40-60% faster - <strong>Parallel processing</strong>: 150-300% faster (2.5-4x speedup) - <strong>Metadata-heavy operations</strong>: 50-80% faster - <strong>Large dataset operations</strong>: 60-100% faster (2x speedup)</p>
</div>
<div class="section level2">
<h2 id="testing-requirements">Testing Requirements<a class="anchor" aria-label="anchor" href="#testing-requirements"></a></h2>
<ol style="list-style-type: decimal"><li>Benchmark current performance on:
<ul><li>Small corpus (&lt; 10 bundles)</li>
<li>Medium corpus (10-100 bundles)</li>
<li>Large corpus (100-1000 bundles)</li>
</ul></li>
<li>Verify correctness:
<ul><li>Results identical to emuR functions</li>
<li>Cache invalidation works correctly</li>
<li>Parallel processing produces same results</li>
</ul></li>
<li>Memory profiling:
<ul><li>Ensure caching doesn’t cause memory issues</li>
<li>Monitor cache size growth</li>
</ul></li>
</ol></div>
<div class="section level2">
<h2 id="notes">Notes<a class="anchor" aria-label="anchor" href="#notes"></a></h2>
<ul><li>Most optimizations are backward compatible</li>
<li>Parallel processing should be optional (default on)</li>
<li>Caching requires careful invalidation logic</li>
<li>Consider adding <code>.use_cache</code> parameter for debugging</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/frkkan96" class="external-link">Fredrik Karlsson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

